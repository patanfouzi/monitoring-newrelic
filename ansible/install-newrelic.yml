- name: Install and configure New Relic Infrastructure agent
  hosts: all
  become: yes
  vars:
    license_key: "{{ lookup('env', 'NEW_RELIC_LICENSE_KEY') }}"  # GitHub Secret
    region: "{{ lookup('env', 'NEW_RELIC_REGION') | default('US') }}"  # Default to US, override with EU if needed
  tasks:
    - name: Ensure apt-transport-https is installed
      apt:
        name: apt-transport-https
        state: present
        update_cache: yes

    - name: Add New Relic GPG key
      ansible.builtin.apt_key:
        url: https://download.newrelic.com/infrastructure_agent/gpg/newrelic-infra.gpg
        state: present

    - name: Add New Relic apt repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://download.newrelic.com/infrastructure_agent/linux/apt {{ ansible_distribution_release }} main"
        state: present

    - name: Install New Relic Infrastructure agent
      ansible.builtin.apt:
        name: newrelic-infra
        state: present
        update_cache: yes

    - name: Configure New Relic license key and region
      ansible.builtin.copy:
        dest: /etc/newrelic-infra.yml
        content: |
          license_key: {{ license_key }}
          {% if region == 'EU' %}
          region: EU
          {% endif %}
        owner: root
        group: root
        mode: '0600'

    - name: Ensure New Relic service is running
      ansible.builtin.systemd:
        name: newrelic-infra
        state: started
        enabled: yes
